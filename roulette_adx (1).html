<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©union Technique ADX groupe - S√©l√©ction Contr√¥l√©e</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #A30000; /* Rouge Brique/Danger */
            --secondary-color: #ffd700; /* Jaune S√©curit√© */
            --background-color-start: #f7f7f7; /* Gris min√©ral clair */
            --background-color-end: #e9e9e9; /* Gris min√©ral fonc√© */
            --text-color: #333;
            --danger-color: #d63031; /* Rouge Vif */
            --success-color: #1e8449; /* Vert S√©curit√© */
            --card-background: linear-gradient(135deg, #fdfdfd, #f0f0f0);
            --button-gradient-primary: linear-gradient(45deg, #A30000, #8A0000);
            --button-gradient-success: linear-gradient(45deg, #1e8449, #176d3a);
            --button-gradient-danger: linear-gradient(45deg, #d63031, #a32323);
            --button-gradient-delete: linear-gradient(45deg, #7b7d7d, #5d6d7e);
            --info-color: #5d6d7e; /* Gris-Bleu Technique */
        }

        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--background-color-start), var(--background-color-end));
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Effet discret type fibre/amiante sur le fond */
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: repeating-linear-gradient(
                135deg, 
                rgba(150, 150, 150, 0.05), 
                rgba(150, 150, 150, 0.05) 2px, 
                transparent 2px, 
                transparent 4px
            );
            z-index: -2;
            pointer-events: none;
        }

        h1, h2, h3 { 
            font-family: 'Fredoka One', cursive;
            color: var(--primary-color); 
            text-align: center; 
            margin-top: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .container {
            background: var(--card-background);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 550px; 
            margin-bottom: 30px;
            border: 2px solid rgba(180, 180, 180, 0.5);
            transition: transform 0.3s ease-in-out;
        }
        .container:hover {
            transform: scale(1.01);
        }

        /* Styles pour les Boutons d'Action */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease-in-out;
            margin: 5px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            font-size: 0.95em;
        }
        .btn-primary { background: var(--button-gradient-primary); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); background: linear-gradient(45deg, #8A0000, #A30000); }
        .btn-danger { background: var(--button-gradient-danger); }
        .btn-danger:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); background: linear-gradient(45deg, #a32323, #d63031); }
        .btn-success { background: var(--button-gradient-success); }
        .btn-success:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); background: linear-gradient(45deg, #176d3a, #1e8449); }
        .btn-info { background: linear-gradient(45deg, #5d6d7e, #4a5766); }
        .btn-info:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .btn-delete-profile { background: var(--button-gradient-delete); }
        .btn-delete-profile:hover { background: linear-gradient(45deg, #4a5766, #5d6d7e); transform: scale(1.05); }

        .btn:disabled { 
            background: #cccccc; 
            cursor: not-allowed; 
            color: #666; 
            box-shadow: none; 
            transform: translateY(0);
            text-shadow: none;
        }
        
        /* Style sp√©cifique au Tableau d'Honneur (Hall of Fame) */
        #hall-of-fame, #history-box {
            background-color: #eef2f5; 
            border: 1px solid #ddd;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: left;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        /* Styles Sp√©cifiques aux Listes */
        .profile-list, #names-list { 
            list-style: none; 
            padding: 0; 
            margin-top: 15px;
        }
        #profiles-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(150, 150, 150, 0.4); 
            background-color: #fcfcfc;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background-color 0.2s;
        }
        #names-list li:hover { background-color: #f0f0f0; }
        .player-absent, .player-temp-absent { background-color: #fff8e1 !important; }
        .player-absent .player-name, .player-temp-absent .player-name { color: var(--info-color); text-decoration: line-through; }
        .player-status { font-size: 0.8em; color: var(--info-color); margin-left: 10px;}
        .probability { font-weight: bold; color: var(--secondary-color); margin-left: 10px; }


        /* ------------------------------------------------ */
        /* NOUVEAU STYLE POUR L'√âCRAN GAGNANT/NOTATION */
        /* ------------------------------------------------ */

        #winner-screen, #rating-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); /* Fond noir plus sombre */
            display: none; justify-content: center; align-items: center;
            flex-direction: column; z-index: 100;
            backdrop-filter: blur(5px);
        }
        #winner-box, #rating-box {
            background: linear-gradient(160deg, #ffffff, #f9f9f9);
            padding: 50px; /* Plus de padding */
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            min-width: 400px;
            border: 4px solid var(--secondary-color);
        }
        #winner-box h2 {
            font-size: 2.5em;
            color: var(--danger-color);
            margin-bottom: 10px;
        }
        #winner-quote {
            font-style: italic;
            font-size: 1.5em;
            color: var(--info-color);
            margin-bottom: 30px;
        }
        #winner-name { 
            font-family: 'Fredoka One', cursive;
            font-size: 6em; /* Tr√®s gros */
            color: var(--success-color); 
            margin: 15px 0 40px 0; 
            font-weight: bold; 
            text-shadow: 5px 5px 10px rgba(0,0,0,0.3);
            line-height: 1;
        }

        /* √âcran de notation */
        #rating-box h2 { color: var(--primary-color); font-size: 2em; }
        #rating-person-name { font-size: 1.8em; font-weight: bold; margin-bottom: 30px; color: var(--text-color); }
        
        .rating-options-container {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Espacement entre les gros boutons */
        }
        .rating-option {
            width: 100%;
            padding: 20px 10px; /* Boutons beaucoup plus grands */
            font-size: 1.2em;
            border-radius: 10px;
        }

        /* Roulette (Styles inchang√©s) */
        #game-section { display: none; text-align: center; }
        .roulette-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 30px auto;
            border-radius: 50%;
            box-shadow: 0 0 0 10px #333, 0 0 0 15px var(--primary-color), 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden; 
            background: white;
            border: 5px solid var(--secondary-color);
        }
        .indicator {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 30px solid var(--danger-color);
            z-index: 10;
        }
        #roulette {
            width: 100%; height: 100%; border-radius: 50%; position: relative;
            transform: rotate(0deg);
            transition: transform 5s cubic-bezier(0.1, 0.7, 0.5, 1);
        }
        .segment {
            position: absolute; width: 50%; height: 50%; transform-origin: 100% 100%;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; 
            font-size: 1.1em;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            border-right: 1px solid rgba(0,0,0,0.2);
        }
        .segment span { display: block; position: absolute; white-space: nowrap; padding: 5px; }

    </style>
</head>
<body>

    <div id="profile-menu" class="container">
        <h1>üöß Gestion des √âquipes Techniques ADX üöß</h1>
        
        <div style="margin-bottom: 20px; display: flex;">
            <input type="text" id="new-profile-name" placeholder="Nom du nouveau Groupe/Chantier..." style="flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px;">
            <button class="btn btn-primary" id="create-profile-btn">Cr√©er le Groupe</button>
        </div>

        <h2>S√©lectionnez votre √âquipe :</h2>
        <ul class="profile-list" id="profiles-list">
            </ul>
    </div>

    <div id="game-config" class="container" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <button class="btn btn-primary" onclick="showScreen('profile-menu')">‚¨ÖÔ∏è Groupes</button>
            <button class="btn btn-danger" id="reset-stats-btn" title="Remet √† z√©ro les victoires et scores de TOUS les participants de ce groupe.">üßπ R√©initialiser les Stats</button>
        </div>

        <h2 id="current-profile-title">Pr√©parez votre √âquipe</h2>

        <div id="hall-of-fame"></div>
        <div id="history-box"></div>
        
        <div style="margin-bottom: 20px; display: flex;">
            <input type="text" id="name-input" placeholder="Ajouter un participant (ex: 'Jean-Mi')..." style="flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px;">
            <button class="btn btn-primary" id="add-name-btn">Ajouter</button>
        </div>

        <h3 style="margin-top: 0;">Liste des Participants :</h3>
        
        <ul id="names-list">
            </ul>
        
        <button class="btn btn-success" id="start-game-btn" disabled style="width: 100%;">Lancez le Tirage de Contr√¥le !</button>
    </div>

    <div id="game-section">
        <button class="btn btn-primary" onclick="showScreen('game-config')" style="margin-bottom: 20px;">‚¨ÖÔ∏è Retour √† la Configuration</button>
        <h2>√âcran de Contr√¥le : Qui est la Star du Jour ?</h2>
        <p style="font-style: italic; font-size: 0.9em;">Seuls les participants non marqu√©s comme absents peuvent √™tre tir√©s au sort. V√©rifiez les probabilit√©s !</p>

        <div class="roulette-container">
            <div class="indicator"></div>
            <div id="roulette">
                </div>
        </div>

        <button class="btn btn-danger" id="spin-btn">Faire Tourner la Roue !</button>
    </div>

    <div id="winner-screen">
        <div id="winner-box">
            <h2>üö® ALERTE S√âCURIT√â ! üö®</h2>
            <p id="winner-quote"></p>
            <p id="winner-name"></p>
            <button class="btn btn-success" id="go-to-rating-btn">√âvaluer la Performance (Contr√¥le Technique)</button>
        </div>
    </div>

    <div id="rating-screen">
        <div id="rating-box">
            <h2>√âvaluation de la Performance</h2>
            <p id="rating-person-name">Noter : [Nom du Gagnant]</p>
            
            <div class="rating-options-container">
                <button class="btn rating-option btn-danger" data-score="0">‚ö†Ô∏è N'a pas lu la r√©union **(0/10)**</button>
                <button class="btn rating-option btn-primary" data-score="3">üü° Allez, il faut un peu plus de rigueur ! **(3/10)**</button>
                <button class="btn rating-option btn-success" data-score="6">üü¢ Pas trop mal, juste un point √† revoir pour le quiz **(6/10)**</button>
                <button class="btn rating-option btn-success" data-score="9">‚úÖ Super, dossier b√©tonn√©, tout est perfectible cependant ! **(9/10)**</button>
            </div>
        </div>
    </div>

    <audio id="spin-sound" src="https://www.soundboard.com/mediafiles/hr/hrQJcM02FhY.mp3" preload="auto" loop></audio> 
    <audio id="win-sound" src="https://www.soundboard.com/mediafiles/mt/mtE4XmQ9lS8.mp3" preload="auto"></audio> 
    <audio id="cheer-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-success-notification-2007.mp3" preload="auto"></audio>

    <script>
        // ----------------------------------------------------
        // VARIABLES GLOBALES ET CONFIGURATION
        // ----------------------------------------------------
        
        let profiles = {};
        try {
            profiles = JSON.parse(localStorage.getItem('adxProfiles')) || {};
        } catch(e) {
            console.error("Erreur de chargement des profils:", e);
        }
        
        let currentProfileKey = localStorage.getItem('adxCurrentProfile') || null;
        let lastWinnerName = null;
        let animationTimeout = null;

        const DOMElements = {
            profileMenu: document.getElementById('profile-menu'),
            gameConfig: document.getElementById('game-config'),
            gameSection: document.getElementById('game-section'),
            winnerScreen: document.getElementById('winner-screen'),
            ratingScreen: document.getElementById('rating-screen'),
            profilesList: document.getElementById('profiles-list'),
            namesList: document.getElementById('names-list'),
            nameInput: document.getElementById('name-input'),
            addNameBtn: document.getElementById('add-name-btn'),
            startGameBtn: document.getElementById('start-game-btn'),
            rouletteElement: document.getElementById('roulette'),
            spinBtn: document.getElementById('spin-btn'),
            winnerNameDisplay: document.getElementById('winner-name'),
            ratingPersonName: document.getElementById('rating-person-name'),
            currentProfileTitle: document.getElementById('current-profile-title'),
            createProfileBtn: document.getElementById('create-profile-btn'),
            hallOfFame: document.getElementById('hall-of-fame'), 
            historyBox: document.getElementById('history-box'), 
            resetStatsBtn: document.getElementById('reset-stats-btn'), 
            // resetAbsenceBtn: document.getElementById('reset-absence-btn'), // SUPPRIM√â
            winnerQuoteDisplay: document.getElementById('winner-quote'),
            spinSound: document.getElementById('spin-sound'),
            winSound: document.getElementById('win-sound'),
            cheerSound: document.getElementById('cheer-sound')
        };
        
        const segmentColors = ['#A30000', '#2E86C1', '#17A589', '#FFD700', '#884EA0', '#D35400', '#2C3E50', '#7B7D7D'];
        
        const winnerQuotes = [
            "F√©licitations, vous avez d√©croch√© le lot... le d√©samiantage du mois !",
            "Le contr√¥le technique est sur vous, l'inspection commence maintenant.",
            "Bravo ! Il est temps de prouver que la minute s√©curit√© a √©t√© √©cout√©e.",
            "Vous √™tes la star du jour, l'√©quipe compte sur vous pour les r√©ponses !",
            "Alerte : Votre performance sera not√©e de 0 √† 9. Bonne chance !",
            "Le destin a parl√© : Pr√©parez-vous √† briller ou √† rougir.",
            "Contr√¥le inopin√© ! Montrez-nous que vous √™tes au top."
        ];


        // ----------------------------------------------------
        // UTILS ET SAUVEGARDE 
        // ----------------------------------------------------

        function saveProfiles() {
            try {
                localStorage.setItem('adxProfiles', JSON.stringify(profiles));
                localStorage.setItem('adxCurrentProfile', currentProfileKey);
                return true;
            } catch (e) {
                console.error("Erreur de sauvegarde dans le localStorage:", e);
                if (e.name === 'QuotaExceededError' || e.name === 'SecurityError') {
                    alert("ERREUR CRITIQUE DE SAUVEGARDE: Le stockage de votre navigateur est plein ou bloqu√© (ex: mode priv√©). Vos donn√©es pourraient ne pas √™tre sauvegard√©es apr√®s le rafra√Æchissement.");
                }
                return false;
            }
        }

        function playSound(audioElement) {
            audioElement.currentTime = 0;
            audioElement.play().catch(e => console.log("Erreur de lecture audio (probablement lecture automatique bloqu√©e):", e));
        }

        function stopSound(audioElement) {
            audioElement.pause();
            audioElement.currentTime = 0;
        }

        function calculateAverage(player) {
            if (player.scores && player.scores.length > 0) {
                const total = player.scores.reduce((sum, score) => sum + score, 0);
                return total / player.scores.length; 
            }
            return 0; 
        }

        function showScreen(screenId) {
            DOMElements.profileMenu.style.display = 'none';
            DOMElements.gameConfig.style.display = 'none';
            DOMElements.gameSection.style.display = 'none';
            DOMElements.winnerScreen.style.display = 'none';
            DOMElements.ratingScreen.style.display = 'none';
            
            stopSound(DOMElements.spinSound);

            if (screenId === 'profile-menu') {
                // On s'assure que le currentProfileKey est nullifi√© si l'utilisateur revient au menu
                currentProfileKey = null;
                saveProfiles();
                renderProfilesMenu();
                DOMElements.profileMenu.style.display = 'block';
            } else if (screenId === 'game-config') {
                if (!currentProfileKey || !profiles[currentProfileKey]) {
                    currentProfileKey = null;
                    saveProfiles();
                    return showScreen('profile-menu');
                }
                updateGroupHallOfFame(); 
                renderHistory();
                renderPlayersList();
                DOMElements.gameConfig.style.display = 'block';
            } else if (screenId === 'game-section') {
                const availablePlayers = getCurrentPlayers().filter(p => !p.absent && !p.tempAbsent);
                 if (availablePlayers.length < 2) { 
                    alert("Ajoutez au moins deux participants pr√™ts avant de lancer la roulette.");
                    return showScreen('game-config');
                 }
                generateRoulette();
                DOMElements.gameSection.style.display = 'block';
            } else if (screenId === 'winner-screen') {
                DOMElements.winnerScreen.style.display = 'flex';
            } else if (screenId === 'rating-screen') {
                DOMElements.ratingScreen.style.display = 'flex';
            }
        }

        // ----------------------------------------------------
        // LOGIQUE DES PROFILS ET GROUPES
        // ----------------------------------------------------
        function renderProfilesMenu() {
            DOMElements.profilesList.innerHTML = '';
            const keys = Object.keys(profiles);

            if (keys.length === 0) {
                DOMElements.profilesList.innerHTML = '<li style="justify-content: center; text-align: center; color: var(--info-color); border: none;">Aucun groupe cr√©√©. Cr√©ez-en un dans le champ ci-dessus.</li>';
                return;
            }

            keys.forEach(key => {
                const profile = profiles[key];
                const li = document.createElement('li');
                
                const players = profile.players || []; 
                
                const totalWins = players.reduce((sum, p) => sum + (p.wins || 0), 0);
                const totalScores = players.flatMap(p => p.scores || []);
                const globalAvg = totalScores.length > 0 ? (totalScores.reduce((sum, score) => sum + score, 0) / totalScores.length).toFixed(1) : 'N/A';

                li.innerHTML = `
                    <span>
                        <span style="font-family: 'Fredoka One', cursive; color: var(--primary-color); font-size: 1.1em;">${profile.name}</span> 
                        (${players.length} participants | Victoires: ${totalWins} | Moyenne: <span class="avg-score">${globalAvg}</span>)
                    </span>
                    <div class="profile-actions">
                        <button class="btn btn-primary btn-select-profile" data-key="${key}">S√©lectionner</button>
                        <button class="btn btn-danger btn-delete-profile" data-key="${key}" style="background: var(--button-gradient-delete);">Supprimer</button>
                    </div>
                `;
                DOMElements.profilesList.appendChild(li);
            });
        }


        function getCurrentPlayers() {
            const profile = profiles[currentProfileKey];
            return profile ? (profile.players || []) : [];
        }

        function selectProfile(key) {
            currentProfileKey = key;
            saveProfiles();
            if (profiles[key]) {
                 DOMElements.currentProfileTitle.textContent = `Pr√©parez votre √âquipe : ${profiles[key].name}`;
                 showScreen('game-config');
            } else {
                 showScreen('profile-menu');
            }
        }
        
        // ----------------------------------------------------
        // GESTION DES JOUEURS ET ABSENCES
        // ----------------------------------------------------
        
        function renderPlayersList() {
            const players = getCurrentPlayers();
            DOMElements.namesList.innerHTML = '';
            
            const availablePlayers = players.filter(p => !p.absent && !p.tempAbsent);
            const totalReady = availablePlayers.length;
            
            players.forEach((player, index) => {
                const li = document.createElement('li');
                const isAbsent = player.absent || false;
                const isTempAbsent = player.tempAbsent || false;
                const avg = calculateAverage(player).toFixed(1);
                
                let statusText = '';
                let probability = '';

                if (isAbsent) {
                    li.classList.add('player-absent');
                    statusText = 'Absence permanente';
                } else if (isTempAbsent) {
                    li.classList.add('player-temp-absent');
                    statusText = 'Absent temporairement (gagnant)';
                } else {
                    if (totalReady > 0) {
                        const probValue = ((1 / totalReady) * 100).toFixed(1);
                        probability = `<span class="probability">${probValue}%</span>`;
                    }
                }

                li.innerHTML = `
                    <div class="player-info">
                        <span class="player-name">${player.name}</span> 
                        (Victoires: ${player.wins || 0} | Moyenne: <span class="avg-score">${avg}</span>)
                        <span class="player-status">${statusText}</span>
                        ${probability}
                    </div>
                    <div class="absent-toggle">
                        <label for="absent-${index}">Absent</label>
                        <input type="checkbox" id="absent-${index}" data-name="${player.name}" ${isAbsent ? 'checked' : ''} ${isTempAbsent ? 'disabled' : ''}>
                        <button class="btn-danger delete-btn" data-name="${player.name}" style="margin-left: 10px; width: 30px; padding: 5px;">X</button>
                    </div>
                `;
                DOMElements.namesList.appendChild(li);
            });
            
            document.querySelectorAll('#names-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.removeEventListener('change', handleAbsenceToggle);
                checkbox.addEventListener('change', handleAbsenceToggle);
            });
            
            DOMElements.startGameBtn.disabled = totalReady < 2;
            DOMElements.startGameBtn.textContent = totalReady < 2 ? `Ajoutez au moins 2 participants (Pr√©sents)` : `Lancez le Tirage (${totalReady} pr√™ts) !`;
        }
        
        function handleAbsenceToggle(event) {
            const playerName = event.target.dataset.name;
            const isChecked = event.target.checked;

            const players = getCurrentPlayers();
            const player = players.find(p => p.name === playerName);

            if (player) {
                player.absent = isChecked;
                player.tempAbsent = false; 
                saveProfiles();
                renderPlayersList();
            }
        }
        
        // La fonction resetTemporaryAbsence est supprim√©e car le bouton l'√©tait aussi

        function applyTemporaryAbsence(playerName) {
            const players = getCurrentPlayers();
            const player = players.find(p => p.name === playerName);
            
            // Retirer l'absence temporaire des anciens gagnants (s'il y en avait)
            players.forEach(p => {
                if (p.tempAbsent) p.tempAbsent = false;
            });

            if (player) {
                player.tempAbsent = true;
                player.absent = false; 
            }
            saveProfiles();
        }

        // ----------------------------------------------------
        // ROULETTE ET ANIMATION
        // ----------------------------------------------------
        
        function generateRoulette() {
            const availablePlayers = getCurrentPlayers().filter(p => !p.absent && !p.tempAbsent);
            
            const numSegments = availablePlayers.length;
            const anglePerSegment = 360 / numSegments;
            DOMElements.rouletteElement.innerHTML = ''; 

            if (numSegments < 2) {
                DOMElements.rouletteElement.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--danger-color); font-size: 1.1em; text-align: center;">Pas assez de participants pr√™ts pour le tirage.</div>`;
                DOMElements.spinBtn.disabled = true;
                return;
            } else {
                 DOMElements.spinBtn.disabled = false;
            }

            availablePlayers.forEach((player, index) => {
                const segment = document.createElement('div');
                segment.classList.add('segment');
                segment.style.backgroundColor = segmentColors[index % segmentColors.length];
                segment.dataset.index = index; 
                segment.dataset.name = player.name; 
                
                segment.style.transform = `rotate(${index * anglePerSegment}deg) skewY(${90 - anglePerSegment}deg)`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name;
                nameSpan.style.transform = `
                    skewY(${-(90 - anglePerSegment)}deg) 
                    rotate(${anglePerSegment / 2}deg) 
                    translate(45%, 0)
                `;
                segment.appendChild(nameSpan);

                DOMElements.rouletteElement.appendChild(segment);
            });
        }
        
        function spinRoulette() {
            if (DOMElements.spinBtn.disabled) return;
            if (animationTimeout) clearTimeout(animationTimeout);

            DOMElements.spinBtn.disabled = true;
            playSound(DOMElements.spinSound); 

            const availablePlayers = getCurrentPlayers().filter(p => !p.absent && !p.tempAbsent);

            if (availablePlayers.length < 2) { 
                DOMElements.spinBtn.disabled = false;
                stopSound(DOMElements.spinSound);
                alert("Erreur: Au moins deux participants pr√©sents sont requis pour le tirage.");
                return;
            }

            const winningIndex = Math.floor(Math.random() * availablePlayers.length);
            lastWinnerName = availablePlayers[winningIndex].name; 

            const numSegments = availablePlayers.length;
            const anglePerSegment = 360 / numSegments;
            
            const randomOffsetWithinSegment = (Math.random() * (anglePerSegment - 10)) + 5; 

            const targetSegmentStartAngle = winningIndex * anglePerSegment;
            const targetVisualAngle = targetSegmentStartAngle + randomOffsetWithinSegment;

            const fullSpins = Math.floor(Math.random() * 6) + 5; 
            
            const targetRotation = (fullSpins * 360) - targetVisualAngle;

            DOMElements.rouletteElement.style.transition = 'transform 5s cubic-bezier(0.1, 0.7, 0.5, 1)';
            DOMElements.rouletteElement.style.transform = `rotate(${targetRotation}deg)`;

            animationTimeout = setTimeout(() => {
                stopSound(DOMElements.spinSound);
                playSound(DOMElements.winSound); 
                
                applyTemporaryAbsence(lastWinnerName);
                
                showWinnerAnnouncement(lastWinnerName);
                animationTimeout = null;
            }, 5500); 
        }

        // ----------------------------------------------------
        // ANNONCE, NOTATION ET STATS
        // ----------------------------------------------------

        function showWinnerAnnouncement(winner) {
            document.getElementById('winner-name').textContent = winner;
            document.getElementById('winner-quote').textContent = winnerQuotes[Math.floor(Math.random() * winnerQuotes.length)];
            showScreen('winner-screen');
        }

        function recordScore(playerName, score) {
            const profile = profiles[currentProfileKey];
            const players = getCurrentPlayers();
            const player = players.find(p => p.name === playerName);

            if (player) {
                player.wins = (player.wins || 0) + 1;

                if (!player.scores) player.scores = [];
                player.scores.push(score);

                if (!profile.history) profile.history = [];
                profile.history.push({
                    name: playerName,
                    score: score,
                    timestamp: Date.now()
                });

                saveProfiles();
            }
        }

        function renderHistory() {
            const profile = profiles[currentProfileKey];
            if (!profile || !profile.history || profile.history.length === 0) {
                DOMElements.historyBox.innerHTML = `<h4>Historique des Tirages :</h4><p style="margin: 0;">Aucun tirage enregistr√© pour ce groupe.</p>`;
                return;
            }

            const historyList = profile.history.slice(-5).reverse(); 
            let html = `<h4>Historique des ${Math.min(5, profile.history.length)} Derniers Tirages :</h4><ul style="list-style: none; padding-left: 15px; font-size: 0.9em;">`;

            historyList.forEach((item) => {
                const scoreDisplay = item.score !== undefined ? `<span style="color: var(--success-color); font-weight: bold;">(${item.score}/10)</span>` : '';
                html += `<li>- ${item.name} ${scoreDisplay}</li>`;
            });

            html += `</ul>`;
            DOMElements.historyBox.innerHTML = html;
        }

        function updateGroupHallOfFame() {
            const players = getCurrentPlayers();
            let bestWinner = { name: "Personne", wins: -1 };
            let bestScorer = { name: "Personne", avg: -1 };

            if (players.length === 0) {
                 DOMElements.hallOfFame.innerHTML = `<h4>Tableau d'Honneur :</h4><p>Ajoutez des participants pour voir le tableau d'honneur de ce groupe !</p>`;
                 return;
            }

            players.forEach(player => {
                const wins = player.wins || 0;
                if (wins > bestWinner.wins) {
                    bestWinner = { name: player.name, wins: wins };
                }
            });

            players.forEach(player => {
                const avg = calculateAverage(player);
                if (avg > bestScorer.avg) {
                    bestScorer = { name: player.name, avg: avg };
                }
            });
            
            const championName = bestWinner.wins > 0 ? `${bestWinner.name} (${bestWinner.wins} victoires)` : "N/A";
            const scorerName = bestScorer.avg > 0 ? `${bestScorer.name} (${bestScorer.avg.toFixed(1)}/10)` : "N/A";

            DOMElements.hallOfFame.innerHTML = `
                <h4>Tableau d'Honneur :</h4>
                <p>üèÖ **Le champion de ce groupe (Victoires) est :** <strong>${championName}</strong></p>
                <p>üåü **Le meilleur score de ce groupe est :** <strong>${scorerName}</strong></p>
            `;
        }

        function resetGroupStats() {
             if (!currentProfileKey) return;
             if (confirm("√ätes-vous S√õR de vouloir r√©initialiser les statistiques (victoires et scores) de TOUS les participants de ce groupe ? Cette action est irr√©versible.")) {
                const players = getCurrentPlayers();
                players.forEach(player => {
                    player.wins = 0;
                    player.scores = [];
                    player.absent = false;
                    player.tempAbsent = false;
                });
                if (profiles[currentProfileKey]) {
                    profiles[currentProfileKey].history = [];
                }
                saveProfiles();
                showScreen('game-config'); 
                alert("Statistiques du groupe r√©initialis√©es avec succ√®s.");
             }
        }

        // ----------------------------------------------------
        // GESTION DES √âV√âNEMENTS GLOBALE
        // ----------------------------------------------------

        function initializeEventListeners() {
            // Cr√©ation de groupe
            DOMElements.createProfileBtn.addEventListener('click', () => {
                 const nameInput = document.getElementById('new-profile-name');
                 const name = nameInput.value.trim();
                 if (!name) return alert("Veuillez donner un nom au nouveau groupe.");
                 const key = `profile_${Date.now()}`;
                 profiles[key] = { name: name, players: [], history: [] };
                 nameInput.value = '';
                 saveProfiles();
                 renderProfilesMenu(); 
            }); 
            
            // S√©lection / Suppression de profil
            DOMElements.profilesList.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('btn-select-profile')) {
                    selectProfile(target.dataset.key);
                } else if (target.classList.contains('btn-delete-profile')) {
                    const key = target.dataset.key;
                     if (confirm(`√ätes-vous s√ªr de vouloir supprimer le profil "${profiles[key].name}" ?`)) {
                        delete profiles[key];
                        if (currentProfileKey === key) currentProfileKey = null;
                        saveProfiles();
                        renderProfilesMenu();
                    }
                }
            });
            
            // Ajout de participant
            DOMElements.addNameBtn.addEventListener('click', () => {
                 const name = DOMElements.nameInput.value.trim();
                 if (!name) return;
                 const players = getCurrentPlayers();
                 if (players.some(p => p.name === name)) return alert("Ce participant existe d√©j√† !");
                 players.push({ name: name, wins: 0, scores: [], absent: false, tempAbsent: false }); 
                 saveProfiles();
                 renderPlayersList();
                 updateGroupHallOfFame();
                 DOMElements.nameInput.value = '';
            });

            // Suppression de participant
            DOMElements.namesList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const name = e.target.dataset.name;
                    const players = getCurrentPlayers();
                    const index = players.findIndex(p => p.name === name);
                    if (index > -1 && confirm(`Supprimer ${name} du groupe ?`)) {
                        players.splice(index, 1);
                        saveProfiles();
                        renderPlayersList();
                        updateGroupHallOfFame(); 
                    }
                }
            });

            DOMElements.resetStatsBtn.addEventListener('click', resetGroupStats);
            
            DOMElements.startGameBtn.addEventListener('click', () => showScreen('game-section'));
            DOMElements.spinBtn.addEventListener('click', spinRoulette);

            // Gestion de la notation
            document.getElementById('go-to-rating-btn').addEventListener('click', () => {
                DOMElements.ratingPersonName.textContent = `Noter : ${lastWinnerName}`;
                showScreen('rating-screen');
            });
            document.querySelectorAll('.rating-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const score = parseInt(e.target.dataset.score);
                    recordScore(lastWinnerName, score);
                    showScreen('game-config'); 
                });
            });
        }
        
        // ----------------------------------------------------
        // LOGIQUE D'INITIALISATION
        // ----------------------------------------------------
        
        initializeEventListeners();

        // NOUVEAU : Toujours d√©marrer sur l'√©cran des groupes
        showScreen('profile-menu');

    </script>
</body>
</html>